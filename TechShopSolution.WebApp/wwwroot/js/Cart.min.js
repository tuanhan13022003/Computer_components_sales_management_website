var CartController=function(){function t(t,e){$.ajax({type:"POST",url:"/Cart/UpdateCart",data:{id:t,quantity:e},success:function(t){$("#lbl_number_items_header").text(t.items.length),n()},error:function(t){console.log(t)}})}function n(){$.ajax({type:"GET",url:"/Cart/GetListItems/",success:function(t){0===t.items.length&&$(".table-cart").hide();var n="",e=0,a=!0,o=!0,c=!0;if($.each(t.items,function(t,i){if(i.promotionPrice>0)var r=i.promotionPrice*i.quantity,l=(i.price-i.promotionPrice)*i.quantity;else r=i.price*i.quantity,l=0;0!=i.instock&&i.isExist&&i.isActive?n+='<tr><td> <img width="60" height="60" src="'+$("#hidBaseAddress").val()+"/user-content/"+i.images+'" alt="" /></td><td class=\'cart-item-name\'><a href=/san-pham/'+i.slug+">"+i.name+'"</a></td><td><div class="input-append"><input class="span1 txtQuantity" style="max-width: 34px" data-id="'+i.id+'" placeholder="1" id="txt_quantity_'+i.id+'" data-count="'+i.quantity+'" value="'+i.quantity+'"  data-instock="'+i.instock+'" size="16" type="text"><button class="btn btn-minus" data-id="'+i.id+'" type ="button"> <i class="icon-minus"></i></button><button class="btn btn-plus" type="button" data-id="'+i.id+'"><i class="icon-plus"></i></button><button class="btn btn-danger btn-remove" type="button" data-id="'+i.id+'"><i class="icon-remove icon-white"></i></button></div></td><td>'+new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(i.price)+"</td><td>"+new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(l)+"</td><td>"+new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(r)+"</td></tr>":(n+='<tr class="unavaiable-product"><td> <img width="60" height="60" src="'+$("#hidBaseAddress").val()+"/user-content/"+i.images+'" alt="" /></td><td class=\'cart-item-name\'><a href=/san-pham/'+i.slug+">"+i.name+'"</a></td><td><div class="input-append text-right"><input class="span1 txtQuantity" readonly="readonly" style="max-width: 34px" data-id="'+i.id+'" placeholder="1" id="txt_quantity_'+i.id+'" data-count="'+i.quantity+'" value="'+i.quantity+'"  data-instock="'+i.instock+'" size="16" type="text"><button class="btn btn-danger btn-remove" type="button" data-id="'+i.id+'"><i class="icon-remove icon-white"></i></button></div></td><td>'+new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(i.price)+"</td><td>"+new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(l)+"</td><td>"+new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(r)+"</td></tr>",i.isExist?i.isActive?0==i.instock&&(o=!1):c=!1:a=!1),e+=r}),null!=t.coupon)if(0==t.coupon.quantity)$("#codeCoupon").val(t.coupon.code),$("#CouponMessage").text("Mã giảm giá này đã được sử dụng hết"),document.getElementById("CouponMessage").style.visibility="visible",$("#cart_body").html(n),$("#lbl_number_of_items").text(t.items.length),$("#lbl_total").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)),$("#lbl_couponprice").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(0)),$("#lbl_maintotal").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e));else if(null!=t.coupon.min_order_value)if(t.coupon.min_order_value>e)$("#codeCoupon").val(t.coupon.code),$("#CouponMessage").text("Chưa đạt giá trị tối thiểu"),document.getElementById("CouponMessage").style.visibility="visible",$("#cart_body").html(n),$("#lbl_number_of_items").text(t.items.length),$("#lbl_total").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)),$("#lbl_couponprice").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(0)),$("#lbl_maintotal").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e));else{$("#codeCoupon").val(t.coupon.code),document.getElementById("CouponMessage").style.visibility="hidden";var i=0;"Phần trăm"==t.coupon.type?(i=e*(t.coupon.value/100),null!=t.coupon.max_value&&t.coupon.max_value<i&&(i=t.coupon.max_value)):"Số tiền"==t.coupon.type&&(i=t.coupon.value>=e?e:t.coupon.value),$("#lbl_couponprice").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(i)),$("#lbl_total").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)),$("#lbl_maintotal").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e-i)),$("#cart_body").html(n),$("#lbl_number_of_items").text(t.items.length)}else{$("#codeCoupon").val(t.coupon.code),document.getElementById("CouponMessage").style.visibility="hidden";i=0;"Phần trăm"==t.coupon.type?(i=e*(t.coupon.value/100),null!=t.coupon.max_value&&t.coupon.max_value<i&&(i=t.coupon.max_value)):"Số tiền"==t.coupon.type&&(i=t.coupon.value>=e?e:t.coupon.value),$("#lbl_couponprice").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(i)),$("#lbl_total").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)),$("#lbl_maintotal").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e-i)),$("#cart_body").html(n),$("#lbl_number_of_items").text(t.items.length)}else $("#cart_body").html(n),$("#lbl_number_of_items").text(t.items.length),$("#lbl_total").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)),$("#lbl_maintotal").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e));a?c?o?$("#btn-purchase").html('<a href="/gio-hang/thanh-toan" class="btn btn-large table-cart">Thanh toán <i class="icon-arrow-right"></i></a>'):(alert("Một sản phẩm trong giỏ hàng của bạn đã hết hàng, vui lòng xóa sản phẩm này khỏi giỏ hàng để thanh toán bạn nhé!"),$("#btn-purchase").html('<button class="btn btn-large table-cart" disabled>Thanh toán <i class="icon-arrow-right"></i></button>')):(alert("Một sản phẩm trong giỏ hàng của bạn hiện tại đang bị khóa, vui lòng xóa sản phẩm này khỏi giỏ hàng để thanh toán bạn nhé! "),$("#btn-purchase").html('<button class="btn btn-large table-cart" disabled>Thanh toán <i class="icon-arrow-right"></i></button>')):(alert("Một sản phẩm trong giỏ hàng của bạn không còn tồn tại hoặc đã bị xóa, vui lòng xóa sản phẩm này khỏi giỏ hàng để thanh toán bạn nhé!"),$("#btn-purchase").html('<button class="btn btn-large table-cart" disabled>Thanh toán <i class="icon-arrow-right"></i></button>'))}})}this.initialize=function(){n(),$("body").on("click",".btn-plus",function(n){n.preventDefault();const e=$(this).data("id"),a=$("#txt_quantity_"+e).data("instock"),o=parseInt($("#txt_quantity_"+e).val())+1;null!=a&&o>a?(alert("Sản phẩm này chỉ còn "+a+" cái, quý khách chỉ được mua tối đa "+a+" sản phẩm."),$(this).val(a),t(e,a)):o>5?alert("Bạn chỉ được mua tối đa 5 sản phẩm"):t(e,o)}),$("body").on("click",".btn-minus",function(n){n.preventDefault();const e=$(this).data("id"),a=parseInt($("#txt_quantity_"+e).val())-1;0==a?confirm("Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?")&&t(e,a):t(e,a)}),$("body").on("click",".btn-remove",function(n){n.preventDefault();const e=$(this).data("id");confirm("Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?")&&t(e,0)}),$("body").on("change",".txtQuantity",function(n){n.preventDefault();const e=$(this).data("id"),a=$(this).data("instock");var o="#txt_quantity_"+e;const c=parseInt($(this).val());c<0?(alert("Số lượng sản phẩm phải lớn hơn 0, mời quý khách nhập lại"),$(this).val($(this).data("count"))):isNaN(c)?(alert("Số lượng phải là chữ số, mời quý khách nhập lại"),$(this).val($(this).data("count"))):null!=a?c>5&&c<a?(alert("Bạn chỉ được mua tối đa 5 sản phẩm"),$(o).val(5),t(e,5)):c>a?(alert("Sản phẩm này chỉ còn "+a+" cái, quý khách chỉ được mua tối đa "+a+" sản phẩm."),$(this).val(a),t(e,a)):t(e,c):c>5?(alert("Bạn chỉ được mua tối đa 5 sản phẩm"),$(o).val(5),t(e,5)):t(e,c)}),$("body").on("click","#btnApplyCoupon",function(){const t=$("#codeCoupon").val();""!=t&&function(t){$.ajax({type:"POST",url:"/Cart/UseCoupon",data:{code:t},success:function(t){var n=0,e=0;$.each(t.items,function(t,e){if(e.promotionPrice>0){var a=e.promotionPrice*e.quantity;e.price,e.promotionPrice,e.quantity}else var a=e.price*e.quantity;n+=a}),"Phần trăm"==t.coupon.type?(e=n*(t.coupon.value/100),null!=t.coupon.max_value&&t.coupon.max_value<e&&(e=t.coupon.max_value)):"Số tiền"==t.coupon.type&&(e=t.coupon.value>=n?n:t.coupon.value),$("#lbl_couponprice").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e)),$("#lbl_maintotal").text(new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(n-e));var a=document.getElementById("btnCancelCoupon");a.setAttribute("type","button");var o=document.getElementById("snackbar");$(".ReultMessage").text("Sử dụng mã giảm giá thành công"),o.className="show",setTimeout(function(){o.className=o.className.replace("show","")},3e3)},error:function(t,n,e){var a=document.getElementById("snackbarDanger");$("#ErrorMessage").text(t.responseText),a.className="show",setTimeout(function(){a.className=a.className.replace("show","")},3e3)}})}(t)})}};$("#btnCancelCoupon").click(function(){confirm("Quý khách có chắn muốn hủy bỏ mã giảm giá này?")&&$.ajax({type:"GET",url:"/Cart/CancelCoupon",success:function(t){document.getElementById("btnCancelCoupon").setAttribute("type","hidden");var n=document.getElementById("snackbar");$(".ReultMessage").text(t),document.getElementById("codeCoupon").value="",document.getElementById("CouponMessage").innerText="",n.className="show",setTimeout(function(){n.className=n.className.replace("show","")},3e3)}})});